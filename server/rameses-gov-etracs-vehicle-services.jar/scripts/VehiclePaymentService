import com.rameses.annotations.*;

public class VehiclePaymentService {
	
	@Service("WorkflowTaskService")
	def taskSvc;

	@DataContext("vehicle_payment")
	def paymentEm;

	@DataContext("vehicle_assessment_item")
	def feeEm;

	@ProxyMethod
	public void postPayment(def o ) {
		def pmt = [:];
		pmt.txndate = o.txndate;
		pmt.appid = o.app.appid;
		pmt.refdate = o.receiptdate;
		pmt.refno = o.receiptno;
		pmt.reftype = "cashreceipt";
		pmt.refid = o.objid;
		pmt.amount = o.amount;
		pmt.voided = 0;
		pmt.txnmode = o.txnmode;
		pmt.remarks = o.remarks;
		pmt.items = o.items.collect{ [refid: it.refid, amount: it.amount, discount: it.discount, surcharge: it.surcharge, interest: it.interest, remarks: it.remarks]  };
		paymentEm.create( pmt );

		//post the amounts into the respective ledgers
		pmt.items.each {
			feeEm.find( [objid: it.refid] ).update( [amount: "{amtpaid + :amt}", amt: it.amount ] );
		}

		if( o.app.taskid !=null ) {
			def m = [processname: 'vehicle_application'];
			m.taskid = o.app.taskid;
			m.refid = o.app.appid;
			m.taskstate = 'payment';
			m.action = 'post';
			taskSvc.signal( m );
		}

	}

	@ProxyMethod
	public void voidPayment(def o ) {
		println ''
		println '** voidPayment ';
		o.each{
			println '>> '+ it;
		}
	}

}