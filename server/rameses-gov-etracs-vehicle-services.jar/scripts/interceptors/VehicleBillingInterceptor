import com.rameses.annotations.*;
import com.rameses.util.*;

class VehicleBillingInterceptor {
	
	@Service("VehicleBillingService")
	def billSvc;

	@DataContext("vw_vehicle_application")
	def vwAppEm;

	@DataContext("vw_vehicle_franchise_unit_active")
	def vwUnitEm;	

	@After(pattern="FormReportService.getData", eval="#{ args[0].reportid == 'vehicle_billing' }")
	public void getBillingData( def evt ) {
		def t = evt.args[0];
		def result = evt.result;

		def appid = t.parameters.appid;

		def app = vwAppEm.find( [objid: appid ] ).first();
		def units = vwUnitEm.find( [franchiseid: app.franchiseid ] ).list();
		def res = billSvc.getBillItems( [appid: appid ] );

		if( !res.billitems )
			throw new Exception("No pending billitems found");

		def data = [:];
		data.putAll( app );
		data.vehicleunits = units; 
		data.billitems = res.billitems.sort{ it.year };
		data.billdate = res.billdate;
		result.data = data;

	}

}