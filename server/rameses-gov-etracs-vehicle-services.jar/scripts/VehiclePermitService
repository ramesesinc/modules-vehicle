import com.rameses.annotations.*;
import java.rmi.server.UID;

class VehiclePermitService {
	
	@Env
	def env;	

	@Service("DateService")
	def dateSvc;

	@DataContext("vehicle_permit")
	def permitEm;

	@DataContext("vehicle_application")
	def appEm;

	@DataContext("vehicle_franchise_year")
	def franYearEm;

	@ProxyMethod 
	public def create( def perm ) { 
		def app = appEm.find([objid: perm.appid]).first();
		if( !perm.permitno ) {
			perm.permitno = "VP" + new UID();
		}
		if(!perm.dtissued) {
			perm.dtissued = dateSvc.getServerDate();
		}
		if(!perm.permittype) perm.permittype = "STANDARD";
		perm.state = "ACTIVE";
		perm.issuedby = [objid: env.USERID, name: env.FULLNAME ];
		perm = permitEm.create( perm );

		appEm.find( [objid:perm.appid] ).update( [permitid: perm.objid ] );
		franYearEm.find( [objid: app.franchiseyearid ] ).update([permitid: perm.objid ] );
		return perm;
	}

}