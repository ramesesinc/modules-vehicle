import com.rameses.annotations.*;
import java.rmi.server.UID;
import com.rameses.util.*;

import treasury.utils.*;
import treasury.facts.*;

class VehicleReportInterceptor {
	
	@DataContext("vw_vehicle_application")
	def appEm;

	@DataContext("vehicle_application_unit")
	def appUnitEm;

	@DataContext("vehicle_assessment_fee")
	def appFeeEm;

	@DataContext("vw_vehicle_permit")
	def permitEm;

	@Service("BillingRuleService")
	def billingRuleSvc;

	@Service("BillingProcessService")
	def billingProcessSvc;

	@Service(value="EntityService", connection="entity-server")
	def entitySvc;

	@After(pattern="FormReportService.getData", eval="#{ args[0].reportid == 'vehicle_application' }")
	public void getApplication(def evt) {
		def p = evt.args[0];
		def result = evt.result;
		def app = appEm.find( [objid: p.parameters.objid ]).first();
		app.vehicleunits = appUnitEm.find( [appid: app.objid ]).list();
		result.data = app;
	}

	@After(pattern="FormReportService.getData", eval="#{ args[0].reportid == 'vehicle_assessment' }")
	public void getAssessment(def evt) {
		def p = evt.args[0];
		def result = evt.result;

		def app  = appEm.find( [objid: p.parameters.objid ]).first();
		app.vehicleunits = appUnitEm.find( [appid: app.objid ]).list();

		def params = [:];
		params.application = app;
		def select = "refid:{objid},item.*,amount,appid,year,month";		
		params.billitems = appFeeEm.select(select).where( "parent.appid= :appid", [appid: app.objid] ).list();
		if(app.dtapproved) params.billdate = app.dtapproved;
		//params.include_billitems = false;
		//params.include_items = true;

		def res = billingRuleSvc.execute( [rulename: "vehiclebilling", params: params ] );
		app.billitems = res.billitems;
		result.data = app;
	}

	@After(pattern="FormReportService.getData", eval="#{ args[0].reportid == 'vehicle_permit' }")
	public void getPermit(def evt) {
		def p = evt.args[0];
		def result = evt.result;
		def perm = permitEm.find([objid: p.parameters.permitid]).first(1);

		//get individual entity info
		//app.owner = entityIndividualEm.find( [objid: app.owner.objid] ).first();
		def ent = entitySvc.open( [objid: perm.owner.objid ] );
		def addr = perm.owner.address;
		perm.owner = ent;
		perm.owner.address = addr;
		result.data = perm;
	}

	@After(pattern="FormReportService.getData", eval="#{ args[0].reportid == 'vehicle_billing' }")
	public void getBilling(def evt) {
		def p = evt.args[0];
		def result = evt.result;

		def parms = [:];
		parms.objid = p.parameters.objid;
		parms.include_items = false;

		def res = billingProcessSvc.process( [rulename:'vehiclebilling', params: parms ]);
		def bill = res.application;
		bill.billitems = res.billitems;
		bill.billdate = res.billdate;
		result.data = bill;
	}

}